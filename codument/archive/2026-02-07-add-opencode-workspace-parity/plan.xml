<?xml version="1.0" encoding="UTF-8"?>
<plan>
  <metadata>
    <track_id>add-opencode-workspace-parity</track_id>
    <track_name>移植 OpenCode workspace 页面（排除 terminal）</track_name>
    <goal>在 ai-cockpit 中实现 OpenCode workspace-opened 页面交互对齐（excluding terminal），并支持多 workspace 管理</goal>
    <created_at>2026-02-06T19:24:42Z</created_at>
    <updated_at>2026-02-07T14:15:29Z</updated_at>
    <status>done</status>
    <commit_mode>manual</commit_mode>
  </metadata>

  <phases>
    <phase id="P1" name="M1 - Cockpit API + Provider Abstraction">
      <goal>完善后端 cockpit API（/api/v1/...）与 provider adapter，以支撑 workspace-opened 页面能力</goal>
      <tasks>
        <task id="T1.1" name="对齐 API contract 与 capabilities" status="DONE" priority="P0" estimated_days="1">
          以 track-local 的 api-contract.md 为准，梳理后端已实现/缺失的 endpoint 与能力开关，并产出差距清单（用于后续任务验收）。
          <references>
            <ref>codument/tracks/add-opencode-workspace-parity/api-contract.md</ref>
            <ref>codument/tracks/add-opencode-workspace-parity/spec.md</ref>
          </references>
          <acceptance_criteria>
            <criterion id="T1.1-AC1" checked="true">差距清单已记录在 parity-matrix.md（或等价文件）中</criterion>
          </acceptance_criteria>
        </task>

        <task id="T1.2" name="Workspaces: connect/list/disconnect" status="DONE" priority="P0" estimated_days="2">
          实现 /api/v1/workspaces/connect、/api/v1/workspaces、DELETE /api/v1/workspaces/{id}，并支持 Authorization Bearer 与 x-proto-session 兼容。
          <references>
            <ref>codument/tracks/add-opencode-workspace-parity/api-contract.md</ref>
            <ref>backend/src/index.ts</ref>
            <ref>backend/src/workspace-registry.ts</ref>
          </references>
          <acceptance_criteria>
            <criterion id="T1.2-AC1" checked="true">可连接多个 workspace，并能 list/switch/disconnect</criterion>
            <criterion id="T1.2-AC2" checked="true">auth 兼容：Bearer 与 x-proto-session 均可用</criterion>
          </acceptance_criteria>
          <subtasks>
            <subtask id="T1.2.1" name="编写 API 测试" status="DONE" estimated_hours="3"/>
            <subtask id="T1.2.2" name="实现 endpoints" status="DONE" estimated_hours="6"/>
            <subtask id="T1.2.3" name="重构与类型收敛" status="DONE" estimated_hours="2"/>
          </subtasks>
        </task>

        <task id="T1.3" name="Sessions endpoints" status="DONE" priority="P0" estimated_days="2">
          实现 sessions list/create/get/update/delete 以及 capability-gated 的 fork/share/revert/summarize 等动作（可先打通基础形态）。
          <references>
            <ref>codument/tracks/add-opencode-workspace-parity/api-contract.md</ref>
          </references>
          <acceptance_criteria>
            <criterion id="T1.3-AC1" checked="true">sessions list/create 可用</criterion>
            <criterion id="T1.3-AC2" checked="true">动作型 endpoints 可按能力启用/禁用</criterion>
          </acceptance_criteria>
          <subtasks>
            <subtask id="T1.3.1" name="编写 API 测试" status="DONE" estimated_hours="3"/>
            <subtask id="T1.3.2" name="实现 endpoints" status="DONE" estimated_hours="6"/>
            <subtask id="T1.3.3" name="重构与错误处理" status="DONE" estimated_hours="2"/>
          </subtasks>
        </task>

        <task id="T1.4" name="Messages + Prompt + Abort + Shell" status="DONE" priority="P0" estimated_days="3">
          实现 messages list、prompt、abort、shell-mode（!）等核心 chat 交互所需接口，并保证与 OpenCode-like parts 形状兼容。
          <references>
            <ref>codument/tracks/add-opencode-workspace-parity/api-contract.md</ref>
            <ref>shared</ref>
          </references>
          <acceptance_criteria>
            <criterion id="T1.4-AC1" checked="true">prompt 可发送 parts 并产生可拉取的 messages</criterion>
            <criterion id="T1.4-AC2" checked="true">abort 可中止 in-flight generation</criterion>
            <criterion id="T1.4-AC3" checked="true">shell-mode 可提交命令（无 terminal UI）</criterion>
          </acceptance_criteria>
          <subtasks>
            <subtask id="T1.4.1" name="编写 API/集成测试" status="DONE" estimated_hours="4"/>
            <subtask id="T1.4.2" name="实现 endpoints" status="DONE" estimated_hours="8"/>
            <subtask id="T1.4.3" name="重构与一致性" status="DONE" estimated_hours="2"/>
          </subtasks>
        </task>

        <task id="T1.5" name="SSE events relay + coalescing" status="DONE" priority="P0" estimated_days="3">
          实现 /events SSE，保证流式更新可驱动前端 store；对高频事件进行合并/降噪，避免 UI 性能问题。
          <references>
            <ref>codument/tracks/add-opencode-workspace-parity/api-contract.md</ref>
            <ref>backend/src/opencode-client.ts</ref>
          </references>
          <acceptance_criteria>
            <criterion id="T1.5-AC1" checked="true">前端可通过 SSE 获得 message/part 增量更新</criterion>
            <criterion id="T1.5-AC2" checked="true">高频事件不会导致明显卡顿（需有验证手段）</criterion>
          </acceptance_criteria>
          <subtasks>
            <subtask id="T1.5.1" name="编写 SSE 测试/脚本" status="DONE" estimated_hours="4"/>
            <subtask id="T1.5.2" name="实现 relay" status="DONE" estimated_hours="8"/>
            <subtask id="T1.5.3" name="合并/降噪策略" status="DONE" estimated_hours="4"/>
          </subtasks>
        </task>

        <task id="T1.6" name="Review diffs + Files + Paths search" status="DONE" priority="P1" estimated_days="3">
          实现 diffs 与文件相关接口（files tree/content/search + paths/search），支撑 review panel 与 command palette。
          <references>
            <ref>codument/tracks/add-opencode-workspace-parity/api-contract.md</ref>
          </references>
          <acceptance_criteria>
            <criterion id="T1.6-AC1" checked="true">可拉取 session diffs（FileDiff[]）</criterion>
            <criterion id="T1.6-AC2" checked="true">paths/search 支撑 palette 的快速搜索</criterion>
          </acceptance_criteria>
        </task>

        <task id="T1.7" name="Permissions + Questions endpoints" status="DONE" priority="P1" estimated_days="2">
          实现 permissions/respond 与 questions/reply/reject，并在 capabilities 中正确标注。
          <references>
            <ref>codument/tracks/add-opencode-workspace-parity/api-contract.md</ref>
          </references>
          <acceptance_criteria>
            <criterion id="T1.7-AC1" checked="true">permission.asked 可被 UI 处理并可回应</criterion>
            <criterion id="T1.7-AC2" checked="true">question 可 reply/reject</criterion>
          </acceptance_criteria>
        </task>

        <task id="T1.8" name="Legacy endpoints remain working" status="DONE" priority="P0" estimated_days="1">
          在新增 v1 API 的同时，确保 /api/config 与 /api/opencode/* 仍可用，避免破坏现有原型能力。
          <references>
            <ref>backend/src/index.ts</ref>
            <ref>frontend/src/App.vue</ref>
          </references>
          <acceptance_criteria>
            <criterion id="T1.8-AC1" checked="true">legacy connect + proxy 能力仍可用</criterion>
          </acceptance_criteria>
        </task>
      </tasks>
      <gate_criteria>
        <criterion>所有 P0 任务完成</criterion>
        <criterion>关键 endpoints 有自动化验证（测试或脚本）</criterion>
      </gate_criteria>
    </phase>

    <phase id="P2" name="M2 - Frontend App Restructure">
      <goal>将单页原型演进为可承载 workspace shell 的 Vue 应用结构（router + store + layout）</goal>
      <tasks>
        <task id="T2.1" name="Introduce router + routes" status="DONE" priority="P0" estimated_days="2">
          新增 workspace 列表/连接页、workspace shell、session 页面路由结构，并完成基础导航。
          <acceptance_criteria>
            <criterion id="T2.1-AC1" checked="true">可从首页进入 workspace shell 与 session 页面</criterion>
          </acceptance_criteria>
          <subtasks>
            <subtask id="T2.1.1" name="编写基础路由测试" status="DONE" estimated_hours="2"/>
            <subtask id="T2.1.2" name="实现路由结构" status="DONE" estimated_hours="6"/>
            <subtask id="T2.1.3" name="重构 App.vue 原型" status="DONE" estimated_hours="4"/>
          </subtasks>
        </task>

        <task id="T2.2" name="State management + persistence" status="DONE" priority="P0" estimated_days="2">
          引入 store（例如 Pinia）管理 workspace/session 状态；实现 multi-workspace token/连接信息持久化（例如 localStorage）以支持刷新恢复。
          <acceptance_criteria>
            <criterion id="T2.2-AC1" checked="true">刷新页面后可恢复已连接 workspaces（按 design.md 决策）</criterion>
          </acceptance_criteria>
        </task>

        <task id="T2.3" name="Workspace shell layout" status="DONE" priority="P0" estimated_days="2">
          实现 sidebar + header + main chat + right panels 的基础布局骨架（明确不包含 terminal 区域）。
          <acceptance_criteria>
            <criterion id="T2.3-AC1" checked="true">workspace shell 布局可稳定承载后续功能</criterion>
          </acceptance_criteria>
        </task>

        <task id="T2.4" name="Sessions list UI" status="DONE" priority="P1" estimated_days="2">
          在 workspace shell 中实现 sessions list 与导航交互。
          <acceptance_criteria>
            <criterion id="T2.4-AC1" checked="true">可在 UI 中列出并切换 sessions</criterion>
          </acceptance_criteria>
        </task>
      </tasks>
      <gate_criteria>
        <criterion>workspace shell 路由与布局可用</criterion>
      </gate_criteria>
    </phase>

    <phase id="P3" name="M3 - Chat + Prompt Input Parity">
      <goal>实现 chat timeline 与 prompt input 的核心交互对齐</goal>
      <tasks>
        <task id="T3.1" name="Chat turn/parts rendering" status="DONE" priority="P0" estimated_days="3">
          实现 turn 分组、parts 渲染、reasoning toggle、status line、auto-scroll、消息定位等交互语义。
          <acceptance_criteria>
            <criterion id="T3.1-AC1" checked="true">chat timeline 支持 parts（text/reasoning/tool）并具备主要交互</criterion>
          </acceptance_criteria>
        </task>

        <task id="T3.2" name="Prompt input parity" status="DONE" priority="P0" estimated_days="3">
          实现 prompt input：agent/model（如支持）、@ agent、/ slash commands、history、attachments、abort。
          <references>
            <ref>codument/tracks/add-opencode-workspace-parity/spec.md</ref>
          </references>
          <acceptance_criteria>
            <criterion id="T3.2-AC1" checked="true">@ 仅用于 agent 选择</criterion>
            <criterion id="T3.2-AC2" checked="true">/ slash commands 可用</criterion>
            <criterion id="T3.2-AC3" checked="true">abort 可用且 UI 状态正确</criterion>
          </acceptance_criteria>
        </task>

        <task id="T3.3" name="Shell-mode (!)" status="DONE" priority="P1" estimated_days="1">
          实现 ! shell-mode 的 UI 与调用路径（不引入 terminal UI）。
          <acceptance_criteria>
            <criterion id="T3.3-AC1" checked="true">! shell-mode 可提交命令并显示结果</criterion>
          </acceptance_criteria>
        </task>

        <task id="T3.4" name="Command palette (Ctrl+P)" status="DONE" priority="P1" estimated_days="2">
          实现 command palette：快捷键打开、搜索、执行；支持打开文件/触发命令。
          <acceptance_criteria>
            <criterion id="T3.4-AC1" checked="true">Ctrl+P/Mod+P 打开 palette 并可执行至少一个真实命令</criterion>
          </acceptance_criteria>
        </task>
      </tasks>
      <gate_criteria>
        <criterion>核心 chat + prompt input 流程可用</criterion>
      </gate_criteria>
    </phase>

    <phase id="P4" name="M4 - Review + Context Parity">
      <goal>实现 review panel 与 context panel 的核心交互对齐</goal>
      <tasks>
        <task id="T4.1" name="Review panel diff viewer" status="DONE" priority="P0" estimated_days="3">
          实现 diff list + unified/split viewer + expand/collapse + view file。
          <acceptance_criteria>
            <criterion id="T4.1-AC1" checked="true">review panel 基本功能可用（含 unified/split）</criterion>
          </acceptance_criteria>
        </task>

        <task id="T4.2" name="Inline comments (no backend persistence)" status="DONE" priority="P1" estimated_days="2">
          支持 diff 行选择与 inline comment，并可将选择内容加入 prompt context；不要求后端持久化（按 design.md 决策）。
          <references>
            <ref>codument/tracks/add-opencode-workspace-parity/design.md</ref>
          </references>
          <acceptance_criteria>
            <criterion id="T4.2-AC1" checked="true">可选中 diff 行并注入到 prompt context</criterion>
          </acceptance_criteria>
        </task>

        <task id="T4.3" name="Context tab" status="DONE" priority="P1" estimated_days="2">
          实现 usage/cost + system prompt + raw message viewer。
          <acceptance_criteria>
            <criterion id="T4.3-AC1" checked="true">context tab 可查看 raw messages</criterion>
          </acceptance_criteria>
        </task>
      </tasks>
      <gate_criteria>
        <criterion>review + context 的主要交互可用</criterion>
      </gate_criteria>
    </phase>

    <phase id="P5" name="M5 - Actions + Permissions">
      <goal>补齐 session/workspace actions 与 permissions flow，并进行 capability gating</goal>
      <tasks>
        <task id="T5.1" name="Session actions" status="DONE" priority="P1" estimated_days="2">
          实现 rename/fork/share/unshare/revert/summarize 等动作入口与状态反馈（按 capability gating）。
          <acceptance_criteria>
            <criterion id="T5.1-AC1" checked="true">actions 在支持时可用，不支持时隐藏/禁用</criterion>
          </acceptance_criteria>
        </task>

        <task id="T5.2" name="Permissions/questions UI" status="DONE" priority="P1" estimated_days="2">
          实现 permission.asked UI、respond flow、auto-accept toggle（excluding terminal），并处理 questions。
          <acceptance_criteria>
            <criterion id="T5.2-AC1" checked="true">权限请求可被用户处理并继续流程</criterion>
          </acceptance_criteria>
        </task>

        <task id="T5.3" name="Status + notifications" status="DONE" priority="P2" estimated_days="1">
          增加状态指示与必要通知，改善 workspace/session 可观测性。
          <acceptance_criteria>
            <criterion id="T5.3-AC1" checked="true">关键状态变化可被用户感知</criterion>
          </acceptance_criteria>
        </task>
      </tasks>
      <gate_criteria>
        <criterion>权限与 actions 在支持的 provider 上可跑通</criterion>
      </gate_criteria>
    </phase>

    <phase id="P6" name="M6 - QA + Hardening">
      <goal>通过 parity matrix 与 QA checklist 完成验收，并补齐关键回归验证</goal>
      <tasks>
        <task id="T6.1" name="Update parity matrix" status="DONE" priority="P0" estimated_days="1">
          按实现进度更新 parity-matrix.md，并明确未完成项与原因。
          <references>
            <ref>codument/tracks/add-opencode-workspace-parity/parity-matrix.md</ref>
          </references>
          <acceptance_criteria>
            <criterion id="T6.1-AC1" checked="true">parity matrix 反映真实实现状态</criterion>
          </acceptance_criteria>
        </task>

        <task id="T6.2" name="Run manual QA checklist" status="DONE" priority="P0" estimated_days="1">
          按 manual-qa-checklist.md 逐项验证核心流程。
          <references>
            <ref>codument/tracks/add-opencode-workspace-parity/manual-qa-checklist.md</ref>
          </references>
          <acceptance_criteria>
            <criterion id="T6.2-AC1" checked="true">手工 checklist 全部通过或记录已知偏差</criterion>
          </acceptance_criteria>
        </task>

        <task id="T6.3" name="Add regression coverage" status="DONE" priority="P1" estimated_days="2">
          为关键交互增加回归验证（至少覆盖 SSE + prompt input + diff 渲染）。
          <acceptance_criteria>
            <criterion id="T6.3-AC1" checked="true">新增回归验证可在 CI/本地重复运行</criterion>
          </acceptance_criteria>
        </task>
      </tasks>
      <gate_criteria>
        <criterion>P0 验收任务完成</criterion>
      </gate_criteria>
    </phase>
  </phases>

  <risks>
    <risk id="R1" name="Scope too large / integration churn" level="high">
      <impact>High</impact>
      <probability>Medium</probability>
      <mitigation>Milestone gating (M1..M6), keep legacy endpoints, and parity matrix driven acceptance</mitigation>
    </risk>
    <risk id="R2" name="SSE high-frequency UI performance" level="medium">
      <impact>Medium</impact>
      <probability>Medium</probability>
      <mitigation>Event coalescing/denoising and incremental store updates (avoid refetch-all)</mitigation>
    </risk>
  </risks>

  <validations>
    <validation id="V1" name="Workspace-opened parity acceptance" status="DONE">
      Validate core flows via parity matrix + manual QA checklist.
      <checks>
        <check name="Parity matrix updated">All in-scope areas tracked and justified</check>
        <check name="Manual QA passed">Core flows pass (connect/sessions/chat/prompt/review/context/permissions)</check>
        <check name="Legacy endpoints">/api/config + /api/opencode/* remain functional during migration</check>
      </checks>
    </validation>
  </validations>

</plan>
