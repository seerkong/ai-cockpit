## 上下文

当前后端以 Bun 内置 `serve` 作为承载层，HTTP 路由、WebSocket 升级与 SSE 中继逻辑分散在入口与大体量手工分支中，迁移成本与回归风险高。
本 Track 目标是在不改变对外契约的前提下，将承载层统一到 Elysia，并保留原实现用于逐项对照。

约束：
- 对外接口严格兼容（路径、方法、状态码、关键字段、错误语义）。
- 迁移仅聚焦承载层，不重写既有业务模块（provider/registry/storage）。
- 保留代码目录中的 Bun.serve 备份，支持回溯核对与应急回滚。

## 方案概览
1. 契约冻结与基线建立
  - 梳理 HTTP/WS/SSE 兼容清单（路径、状态码、错误体、关键事件序列）。
  - 以现有后端与 e2e 测试作为回归基线。
2. 原实现备份与映射
  - 将 `backend/src/index.ts`、`backend/src/app.ts`、`backend/src/realtime-ws.ts` 备份到 `backend/src/legacy/bun-serve/`。
  - 记录备份文件与迁移后模块映射关系，便于逐项核对。
3. Elysia 承载初始化
  - 新建 Elysia 入口并接入生命周期管理（启动、关闭、清理）。
  - 先打通 health/CORS/OPTIONS/not-found 等基础能力。
4. HTTP 路由分域迁移
  - 按域迁移（config/workspaces/sessions/files/opencode proxy）。
  - 尽量复用现有业务函数，仅替换路由匹配与请求分发方式。
5. SSE 与 WebSocket 迁移
  - SSE 保留现有事件合并与持久化语义。
  - WS 保留既有协议解析、订阅模型与广播语义，仅替换承载绑定。
6. 切换与观察
  - 默认启用 Elysia，同时保留 legacy 回退开关。
  - 观察期以兼容测试与关键链路验证作为放行条件。

## 影响范围与修改点（Impact）
- 受影响的文件/模块：
  - `backend/src/index.ts`（入口承载替换）
  - `backend/src/app.ts`（手工路由拆分迁移）
  - `backend/src/realtime-ws.ts`（WS 绑定适配）
  - `backend/src/opencode-server.ts`（端口探测与启动细节核对）
  - `backend/src/legacy/bun-serve/`（新增备份目录）
  - `backend/src/*.test.ts` 与 `e2e/*.spec.ts`（兼容验证补强）

## 决策
- 决策：仅替换承载层，不重构业务模块
  - 原因：降低变更面，利用现有测试覆盖控制回归。
  - 考虑的替代方案：同步重构业务模块；放弃，因超出本 Track 目标且风险更高。

- 决策：采用“先兼容、后收敛”的分批迁移
  - 原因：每批都可独立验证，便于定位差异来源。
  - 考虑的替代方案：一次性重写；放弃，因难以稳定对齐兼容语义。

- 决策：错误返回继续显式构造，不依赖框架默认封装
  - 原因：确保错误体和状态码与既有客户端预期一致。
  - 考虑的替代方案：使用默认异常链路；放弃，因可能改变错误语义。

- 决策：保留 runtime 回退能力
  - 原因：上线观察期内可快速回切，降低故障恢复成本。
  - 考虑的替代方案：直接移除旧入口；放弃，因回滚成本高。

## 风险 / 权衡
- 路由匹配顺序差异导致命中偏移 → 建立旧路由到新路由映射表并补齐 404/405 回归断言。
- WS 升级与背压行为差异 → 增加高频 patch、断连重连和多订阅场景测试。
- SSE 断流/资源释放行为漂移 → 强化 abort 处理和长连接 soak 测试。
- 框架默认 CORS/错误处理影响响应格式 → 全量显式设置响应头与错误体。
- 引入新依赖带来维护成本 → 仅引入必要 Elysia 相关依赖并锁定版本策略。

回滚策略：
- 保留 `backend/src/legacy/bun-serve/` 代码备份与 runtime 开关（如 `BACKEND_RUNTIME=legacy|elysia`）。
- 若发现兼容回归，可回切 legacy 承载并重启服务，不涉及数据迁移回滚。

## 兼容性设计
- HTTP 兼容
  - 保持既有路径、方法、查询参数语义与关键响应字段。
  - 保持认证提取优先级与失败状态码语义一致。
- 错误语义兼容
  - 保持 401/403/404/405/409/501/502/500 等关键错误语义与结构。
  - 保持特殊历史语义（例如部分探活接口返回 200 + 失败体）。
- WebSocket 兼容
  - 保持升级路径、鉴权与消息协议不变。
  - 保持 snapshot/patch 推送行为与订阅粒度不变。
- SSE 兼容
  - 保持事件流头部、顺序、聚合与断连行为一致。
  - 保持事件持久化与会话关联行为一致。

## 迁移计划
1. 固化兼容基线：补齐关键断言并记录对照清单。
2. 创建并提交 Bun.serve 代码备份（代码目录）。
3. 引入 Elysia 入口并打通基础路由（health/CORS/OPTIONS/not-found）。
4. 分批迁移 HTTP 路由并逐批通过测试。
5. 迁移 SSE 并完成长连接稳定性验证。
6. 迁移 WebSocket 并完成协议与压力场景验证。
7. 开启默认 Elysia，保留 fallback，执行全量回归。
8. 观察期通过后冻结迁移结果，保留备份用于后续核对。

## 待解决问题
- Elysia 下 WS 背压参数是否可与当前行为完全等价。
- fallback 开关保留时长与退出标准（如连续若干天无兼容告警）。
- e2e 是否已覆盖 SSE 重连与 WS 高频 patch 的足够强度。
- 备份目录是否后续只读冻结，还是允许按版本补充映射说明。
