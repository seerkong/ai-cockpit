# 规范：后端迁移为 Elysia 承载

## 概述

本 Track 将把当前后端从 Bun 内置 `serve` 的手工路由形态，迁移为基于 Elysia 的服务承载形态。
本次为全量迁移，包含 HTTP、WebSocket、SSE 三类能力；对外接口行为要求严格兼容。
同时需要保留原 Bun.serve 实现文件的代码级备份，便于后续逐项核对功能是否丢失。

## ADDED Requirements

### Requirement: Elysia 统一承载后端入口
后端服务 MUST 使用 Elysia 作为统一入口承载 HTTP 请求处理，不再以 Bun 内置 `serve` 作为主路由实现。

#### Scenario: 服务以 Elysia 成功启动
- **GIVEN** 后端运行环境配置完整
- **WHEN** 启动后端服务
- **THEN** 服务由 Elysia 实例对外监听
- **AND** 服务可正常响应健康检查与基础 API 请求

### Requirement: HTTP 接口严格兼容
迁移后系统 MUST 对既有 HTTP 接口保持严格兼容，包括路径、方法、状态码、关键响应字段与错误语义。

#### Scenario: 既有 API 调用保持一致行为
- **GIVEN** 已存在的客户端按原有方式发起请求
- **WHEN** 请求到达迁移后的后端
- **THEN** 返回的状态码与关键响应结构与迁移前一致
- **AND** 认证与权限相关失败语义保持一致

### Requirement: 实时能力全量迁移并保持兼容
迁移后系统 MUST 在 Elysia 承载下提供与原系统等价的 WebSocket 与 SSE 行为。

#### Scenario: WebSocket 行为兼容
- **GIVEN** 客户端按既有协议建立 WebSocket 连接
- **WHEN** 连接升级并发生实时事件
- **THEN** 客户端可接收与原实现等价的事件数据
- **AND** 连接鉴权、订阅、断连处理与错误行为保持一致

#### Scenario: SSE 行为兼容
- **GIVEN** 客户端按既有方式订阅 SSE 流
- **WHEN** 后端产生并转发事件
- **THEN** SSE 流可持续输出与原实现等价的事件序列
- **AND** 连接中断与重连后的行为与原实现一致

### Requirement: 原 Bun.serve 文件代码级备份
系统 MUST 在代码目录中保留原 Bun.serve 相关实现文件备份，供迁移后进行功能逐项核对。

#### Scenario: 备份可用于回溯对照
- **GIVEN** 迁移实现已完成
- **WHEN** 开发者需要核对某个能力是否发生缺失
- **THEN** 可在代码目录中的备份文件查看原实现
- **AND** 备份内容可明确映射到迁移前关键逻辑

### Requirement: 启动与测试链路可在迁移后持续工作
系统 MUST 在迁移后保持开发启动、测试执行和构建流程可运行。

#### Scenario: 迁移后开发与测试命令可执行
- **GIVEN** 后端代码已迁移到 Elysia
- **WHEN** 执行既定的开发启动与测试命令
- **THEN** 服务可正常启动并通过核心后端测试
- **AND** 关键端到端链路可用

## 非功能需求

- 迁移以“行为等价优先”为原则，避免引入额外用户可感知行为变化。
- 路由与实时逻辑需具备可维护性，减少大体量手工分支判断。
- 迁移后新增依赖需最小化并可说明其必要性。

## 验收标准

- 后端入口由 Elysia 承载，且核心 API 可用。
- 既有 HTTP 接口在关键行为上与迁移前严格兼容。
- WebSocket 与 SSE 核心流程可用且协议行为不回退。
- 原 Bun.serve 相关文件已按约定完成代码目录备份。
- 迁移后开发启动、核心测试与关键链路验证通过。

## 范围外事项

- 不在本 Track 内新增业务能力或调整产品交互流程。
- 不在本 Track 内重设计现有 API 契约。
- 不在本 Track 内进行与迁移无关的大规模代码风格重构。
