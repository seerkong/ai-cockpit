<?xml version="1.0" encoding="UTF-8"?>
<plan>
  <metadata>
    <track_id>refactor-backend-to-elysia</track_id>
    <track_name>后端从 Bun.serve 重构为 Elysia 承载</track_name>
    <goal>在保持 HTTP、WebSocket、SSE 严格兼容的前提下完成承载层迁移，并保留原实现备份用于功能对照</goal>
    <created_at>2026-02-23T17:56:24Z</created_at>
    <updated_at>2026-02-23T18:50:37Z</updated_at>
    <status>in_progress</status>
    <commit_mode>manual</commit_mode>
    <references>
      <ref type="track-doc" path="codument/tracks/refactor-backend-to-elysia/spec.md" />
      <ref type="track-doc" path="codument/tracks/refactor-backend-to-elysia/proposal.md" />
      <ref type="track-doc" path="codument/tracks/refactor-backend-to-elysia/design.md" />
    </references>
  </metadata>
  <progress>
    <completed>11</completed>
    <in_progress>0</in_progress>
    <todo>0</todo>
  </progress>
  <phases>
    <phase id="P1" name="迁移准备与基线固化">
      <goal>建立兼容基线、完成 Bun.serve 代码备份、搭建 Elysia 承载骨架</goal>
      <estimated_days>2</estimated_days>
      <tasks>
        <task id="T1.1" name="建立兼容基线清单" status="DONE" priority="P0" estimated_days="1">
          梳理现有 HTTP、WS、SSE 契约并补齐关键断言，形成迁移前回归基线
          <acceptance_criteria>
            <criterion id="T1.1-AC1" checked="true">形成可执行的兼容基线清单</criterion>
            <criterion id="T1.1-AC2" checked="true">关键接口与实时协议断言可自动验证</criterion>
          </acceptance_criteria>
          <subtasks>
            <subtask id="T1.1.1" name="编写/补齐契约测试（红）" status="DONE" estimated_hours="3" />
            <subtask id="T1.1.2" name="校准现有行为并更新断言（绿）" status="DONE" estimated_hours="3" />
            <subtask id="T1.1.3" name="整理兼容基线文档与映射" status="DONE" estimated_hours="2" />
          </subtasks>
        </task>
        <task id="T1.2" name="备份 Bun.serve 原实现文件" status="DONE" priority="P0" estimated_days="0.5">
          将原 Bun.serve 相关核心文件备份到代码目录，供后续功能核对
          <dependencies>T1.1</dependencies>
          <acceptance_criteria>
            <criterion id="T1.2-AC1" checked="true">在 backend/src/legacy/bun-serve 下保留原实现副本</criterion>
            <criterion id="T1.2-AC2" checked="true">备份文件与原入口/路由/WS 文件一一对应</criterion>
          </acceptance_criteria>
          <subtasks>
            <subtask id="T1.2.1" name="创建备份目录与结构" status="DONE" estimated_hours="1" />
            <subtask id="T1.2.2" name="复制原入口/路由/WS 文件" status="DONE" estimated_hours="1" />
            <subtask id="T1.2.3" name="补充备份说明与映射信息" status="DONE" estimated_hours="1" />
          </subtasks>
        </task>
        <task id="T1.3" name="引入 Elysia 承载骨架" status="DONE" priority="P0" estimated_days="0.5">
          新建 Elysia 应用入口并接入基础生命周期，保留 runtime fallback 能力
          <dependencies>T1.2</dependencies>
          <acceptance_criteria>
            <criterion id="T1.3-AC1" checked="true">后端可由 Elysia 启动并响应基础请求</criterion>
            <criterion id="T1.3-AC2" checked="true">保留可切回 legacy 的运行开关</criterion>
          </acceptance_criteria>
          <subtasks>
            <subtask id="T1.3.1" name="编写入口切换测试（红）" status="DONE" estimated_hours="2" />
            <subtask id="T1.3.2" name="实现 Elysia 入口与生命周期（绿）" status="DONE" estimated_hours="3" />
            <subtask id="T1.3.3" name="清理初始化逻辑并保持可维护性" status="DONE" estimated_hours="1" />
          </subtasks>
        </task>
      </tasks>
      <gate_criteria>
        <criterion>兼容基线可执行且结果可复现</criterion>
        <criterion>Bun.serve 代码备份已落地并可对照</criterion>
        <criterion>Elysia 承载骨架可启动并保留 fallback</criterion>
      </gate_criteria>
    </phase>
    <phase id="P2" name="HTTP 路由迁移">
      <goal>将既有 HTTP 接口迁移到 Elysia，并保持路径、状态码和错误语义兼容</goal>
      <estimated_days>3</estimated_days>
      <tasks>
        <task id="T2.1" name="迁移基础路由与通用行为" status="DONE" priority="P0" estimated_days="1">
          迁移 health、CORS、OPTIONS、404 等通用行为，确保基础兼容
          <dependencies>T1.3</dependencies>
          <acceptance_criteria>
            <criterion id="T2.1-AC1" checked="true">基础路径行为与旧实现一致</criterion>
            <criterion id="T2.1-AC2" checked="true">CORS/OPTIONS/404 错误语义保持兼容</criterion>
          </acceptance_criteria>
          <subtasks>
            <subtask id="T2.1.1" name="编写通用行为回归测试（红）" status="DONE" estimated_hours="2" />
            <subtask id="T2.1.2" name="实现 Elysia 通用路由与响应（绿）" status="DONE" estimated_hours="3" />
            <subtask id="T2.1.3" name="重构公共响应构造与校验" status="DONE" estimated_hours="1" />
          </subtasks>
        </task>
        <task id="T2.2" name="迁移 workspace/session/config 接口" status="DONE" priority="P0" estimated_days="1">
          迁移工作区、会话、配置相关接口到 Elysia 路由层
          <dependencies>T2.1</dependencies>
          <acceptance_criteria>
            <criterion id="T2.2-AC1" checked="true">关键业务接口状态码与响应结构一致</criterion>
            <criterion id="T2.2-AC2" checked="true">认证与权限失败语义保持一致</criterion>
          </acceptance_criteria>
          <subtasks>
            <subtask id="T2.2.1" name="编写接口兼容测试（红）" status="DONE" estimated_hours="3" />
            <subtask id="T2.2.2" name="实现路由迁移并复用业务模块（绿）" status="DONE" estimated_hours="4" />
            <subtask id="T2.2.3" name="收敛参数解析与错误处理" status="DONE" estimated_hours="2" />
          </subtasks>
        </task>
        <task id="T2.3" name="迁移 files 与代理转发接口" status="DONE" priority="P1" estimated_days="1">
          迁移文件与上游代理转发相关接口，保持查询参数和回包兼容
          <dependencies>T2.2</dependencies>
          <acceptance_criteria>
            <criterion id="T2.3-AC1" checked="true">查询参数兼容映射行为一致</criterion>
            <criterion id="T2.3-AC2" checked="true">代理转发响应与错误处理兼容</criterion>
          </acceptance_criteria>
          <subtasks>
            <subtask id="T2.3.1" name="编写参数映射和代理测试（红）" status="DONE" estimated_hours="2" />
            <subtask id="T2.3.2" name="实现 files 与 proxy 路由迁移（绿）" status="DONE" estimated_hours="4" />
            <subtask id="T2.3.3" name="重构共用转发工具" status="DONE" estimated_hours="2" />
          </subtasks>
        </task>
      </tasks>
      <gate_criteria>
        <criterion>HTTP 核心接口兼容测试全部通过</criterion>
        <criterion>未引入新的高优先级兼容缺陷</criterion>
      </gate_criteria>
    </phase>
    <phase id="P3" name="实时链路迁移（SSE 和 WebSocket）">
      <goal>在 Elysia 承载下保持 SSE 与 WS 协议和实时行为兼容</goal>
      <estimated_days>3</estimated_days>
      <tasks>
        <task id="T3.1" name="迁移 SSE 事件流接口" status="DONE" priority="P0" estimated_days="1">
          迁移 events SSE 接口，保持事件聚合、顺序和断连行为兼容
          <dependencies>T2.3</dependencies>
          <acceptance_criteria>
            <criterion id="T3.1-AC1" checked="true">SSE 头部与事件序列语义保持一致</criterion>
            <criterion id="T3.1-AC2" checked="true">断连与异常时的返回语义兼容</criterion>
          </acceptance_criteria>
          <subtasks>
            <subtask id="T3.1.1" name="编写 SSE 行为回归测试（红）" status="DONE" estimated_hours="3" />
            <subtask id="T3.1.2" name="实现 SSE 路由迁移与适配（绿）" status="DONE" estimated_hours="4" />
            <subtask id="T3.1.3" name="优化流资源释放与稳定性" status="DONE" estimated_hours="2" />
          </subtasks>
        </task>
        <task id="T3.2" name="迁移 WebSocket 实时通道" status="DONE" priority="P0" estimated_days="1">
          迁移 WS 升级与消息处理绑定，保持订阅、快照和 patch 推送语义
          <dependencies>T3.1</dependencies>
          <acceptance_criteria>
            <criterion id="T3.2-AC1" checked="true">WS 握手鉴权与失败语义保持一致</criterion>
            <criterion id="T3.2-AC2" checked="true">订阅和 patch 行为与旧实现等价</criterion>
          </acceptance_criteria>
          <subtasks>
            <subtask id="T3.2.1" name="编写 WS 协议回归测试（红）" status="DONE" estimated_hours="3" />
            <subtask id="T3.2.2" name="实现 WS 绑定迁移与协议复用（绿）" status="DONE" estimated_hours="4" />
            <subtask id="T3.2.3" name="优化背压与断连恢复处理" status="DONE" estimated_hours="2" />
          </subtasks>
        </task>
        <task id="T3.3" name="实时高风险场景兼容验证" status="DONE" priority="P1" estimated_days="1">
          覆盖高频 patch、多订阅、重连与长连接稳定性场景
          <dependencies>T3.2</dependencies>
          <acceptance_criteria>
            <criterion id="T3.3-AC1" checked="true">高频实时场景无关键功能回退</criterion>
            <criterion id="T3.3-AC2" checked="true">长连接稳定性满足既有质量门槛</criterion>
          </acceptance_criteria>
          <subtasks>
            <subtask id="T3.3.1" name="补充高风险实时场景测试" status="DONE" estimated_hours="3" />
            <subtask id="T3.3.2" name="执行压力和稳定性验证" status="DONE" estimated_hours="3" />
            <subtask id="T3.3.3" name="修复差异并复测" status="DONE" estimated_hours="2" />
          </subtasks>
        </task>
      </tasks>
      <gate_criteria>
        <criterion>SSE 与 WS 兼容回归通过</criterion>
        <criterion>关键实时链路验证通过并可复现</criterion>
      </gate_criteria>
    </phase>
    <phase id="P4" name="切换验收与交付收敛">
      <goal>完成全量验证、默认切换与交付文档收敛</goal>
      <estimated_days>1</estimated_days>
      <tasks>
        <task id="T4.1" name="执行全量测试与覆盖率验证" status="DONE" priority="P0" estimated_days="0.5">
          执行后端和关键 e2e 测试，验证覆盖率与构建稳定性
          <dependencies>T3.3</dependencies>
          <acceptance_criteria>
            <criterion id="T4.1-AC1" checked="true">核心后端测试全部通过</criterion>
            <criterion id="T4.1-AC2" checked="true">关键端到端链路可用</criterion>
            <criterion id="T4.1-AC3" checked="true">覆盖率满足项目门槛</criterion>
          </acceptance_criteria>
          <subtasks>
            <subtask id="T4.1.1" name="运行全量自动化测试" status="DONE" estimated_hours="2" />
            <subtask id="T4.1.2" name="定位并修复残余兼容问题" status="DONE" estimated_hours="3" />
          </subtasks>
        </task>
        <task id="T4.2" name="默认切换与迁移交付" status="DONE" priority="P1" estimated_days="0.5">
          默认启用 Elysia 承载，保留 fallback，并整理备份映射与验收记录
          <dependencies>T4.1</dependencies>
          <acceptance_criteria>
            <criterion id="T4.2-AC1" checked="true">默认运行路径为 Elysia</criterion>
            <criterion id="T4.2-AC2" checked="true">fallback 机制可验证可用</criterion>
            <criterion id="T4.2-AC3" checked="true">迁移对照与验收记录完整</criterion>
          </acceptance_criteria>
          <subtasks>
            <subtask id="T4.2.1" name="切换默认入口到 Elysia" status="DONE" estimated_hours="1" />
            <subtask id="T4.2.2" name="验证 fallback 切回链路" status="DONE" estimated_hours="1" />
            <subtask id="T4.2.3" name="整理迁移对照清单与交付说明" status="DONE" estimated_hours="2" />
          </subtasks>
        </task>
      </tasks>
      <confirm protocol="yield-human-confirm" when="after" status="IN_PROGRESS" />
      <gate_criteria>
        <criterion>所有 P0 任务完成</criterion>
        <criterion>兼容目标与验收标准全部满足</criterion>
      </gate_criteria>
    </phase>
  </phases>
  <validations>
    <validation id="V1" name="HTTP 兼容验收" status="PASSED">
      验证迁移后 HTTP 接口保持路径、状态码和关键响应兼容
      <checks>
        <check name="路径与方法兼容">核心接口路径和方法不变</check>
        <check name="错误语义兼容">认证与权限相关错误语义不变</check>
        <check name="代理接口兼容">关键代理接口响应结构保持一致</check>
      </checks>
    </validation>
    <validation id="V2" name="实时链路兼容验收" status="PASSED">
      验证迁移后 SSE 与 WebSocket 行为兼容且稳定
      <checks>
        <check name="SSE 事件兼容">事件顺序、聚合和断连行为一致</check>
        <check name="WS 协议兼容">订阅、快照和 patch 推送行为一致</check>
        <check name="稳定性验证">高频与长连接场景通过验证</check>
      </checks>
    </validation>
  </validations>
  <summary>
    <total_phases>4</total_phases>
    <total_tasks>11</total_tasks>
    <total_subtasks>32</total_subtasks>
    <total_estimated_days>9</total_estimated_days>
    <completed>11</completed>
    <in_progress>0</in_progress>
    <todo>0</todo>
    <blocked>0</blocked>
    <by_priority>
      <p0 count="8" days="6" />
      <p1 count="3" days="3" />
      <p2 count="0" days="0" />
    </by_priority>
  </summary>
</plan>
