<?xml version="1.0" encoding="UTF-8"?>
<plan>
  <metadata>
    <track_id>refactor-session-dockview-decompose</track_id>
    <track_name>SessionDockview 组件拆分与 Chunk 优化</track_name>
    <goal>将 SessionDockview.vue 2280 行单体文件按职责拆分为 Vue composables，通用面板 wrapper 工厂简化 Options API 代码，并通过 dynamic import 懒加载优化 1.2MB chunk size</goal>
    <created_at>2026-02-21T12:00:00Z</created_at>
    <updated_at>2026-02-21T12:00:00Z</updated_at>
    <status>completed</status>
    <commit_mode>manual</commit_mode>
  </metadata>

  <phases>
    <phase id="P1" name="底层 Composables 抽取">
      <goal>抽取无依赖或低依赖的 composables：useNotifications、useDockviewLayout、useComposerMetadata</goal>
      <tasks>
        <task id="T1.1" name="抽取 useNotifications composable" status="DONE" priority="P0">
          将通知列表状态和 pushNotification 函数从 SessionDockview.vue 抽取到 frontend/src/composables/useNotifications.ts。
          包含 notifications ref、pushNotification 函数（含 setTimeout 自动过期）。
          <acceptance_criteria>
            <criterion id="T1.1-AC1" checked="true">useNotifications.ts 文件存在且导出 useNotifications 函数</criterion>
            <criterion id="T1.1-AC2" checked="true">SessionDockview.vue 中通知相关代码替换为 composable 调用</criterion>
            <criterion id="T1.1-AC3" checked="true">bun test 前端全部通过</criterion>
            <criterion id="T1.1-AC4" checked="true">bun run build 通过</criterion>
          </acceptance_criteria>
          <references>
            <ref>frontend/src/pages/SessionDockview.vue:237-245</ref>
          </references>
          <subtasks>
            <subtask id="T1.1.1" name="编写 useNotifications 测试" status="DONE"/>
            <subtask id="T1.1.2" name="实现 useNotifications composable" status="DONE"/>
            <subtask id="T1.1.3" name="替换 SessionDockview.vue 中通知代码" status="DONE"/>
          </subtasks>
        </task>

        <task id="T1.2" name="抽取 useDockviewLayout composable" status="DONE" priority="P0">
          将 Dockview 布局持久化逻辑从 SessionDockview.vue 抽取到 frontend/src/composables/useDockviewLayout.ts。
          包含 dockApi ref、saveLayout、restoreLayout、createDefaultLayout、onReady 函数。
          LAYOUT_STORAGE_KEY 常量移入 composable。
          <dependencies>T1.1</dependencies>
          <acceptance_criteria>
            <criterion id="T1.2-AC1" checked="true">useDockviewLayout.ts 文件存在且导出 useDockviewLayout 函数</criterion>
            <criterion id="T1.2-AC2" checked="true">SessionDockview.vue 中布局相关代码替换为 composable 调用</criterion>
            <criterion id="T1.2-AC3" checked="true">布局持久化功能正常（save/restore/default）</criterion>
            <criterion id="T1.2-AC4" checked="true">bun test 前端全部通过</criterion>
            <criterion id="T1.2-AC5" checked="true">bun run build 通过</criterion>
          </acceptance_criteria>
          <references>
            <ref>frontend/src/pages/SessionDockview.vue:1523-1646</ref>
          </references>
          <subtasks>
            <subtask id="T1.2.1" name="编写 useDockviewLayout 测试" status="DONE"/>
            <subtask id="T1.2.2" name="实现 useDockviewLayout composable" status="DONE"/>
            <subtask id="T1.2.3" name="替换 SessionDockview.vue 中布局代码" status="DONE"/>
          </subtasks>
        </task>

        <task id="T1.3" name="抽取 useComposerMetadata composable" status="DONE" priority="P0">
          将 agents/models/commands 获取和规范化逻辑从 SessionDockview.vue 抽取到 frontend/src/composables/useComposerMetadata.ts。
          包含 agentOptions、modelOptions、commandOptions、capabilities 状态，以及 refreshComposerMetadata 和所有 normalize 函数。
          <dependencies>T1.1</dependencies>
          <acceptance_criteria>
            <criterion id="T1.3-AC1" checked="true">useComposerMetadata.ts 文件存在且导出 useComposerMetadata 函数</criterion>
            <criterion id="T1.3-AC2" checked="true">SessionDockview.vue 中元数据相关代码替换为 composable 调用</criterion>
            <criterion id="T1.3-AC3" checked="true">bun test 前端全部通过</criterion>
            <criterion id="T1.3-AC4" checked="true">bun run build 通过</criterion>
          </acceptance_criteria>
          <references>
            <ref>frontend/src/pages/SessionDockview.vue:839-987</ref>
          </references>
          <subtasks>
            <subtask id="T1.3.1" name="编写 useComposerMetadata 测试" status="DONE"/>
            <subtask id="T1.3.2" name="实现 useComposerMetadata composable" status="DONE"/>
            <subtask id="T1.3.3" name="替换 SessionDockview.vue 中元数据代码" status="DONE"/>
          </subtasks>
        </task>
      </tasks>
      <gate_criteria>
        <criterion>所有 P0 任务完成</criterion>
        <criterion>bun test 前端 15/15 通过</criterion>
        <criterion>bun run build 通过</criterion>
        <criterion>SessionDockview.vue 行数明显减少</criterion>
      </gate_criteria>
    </phase>

    <phase id="P2" name="核心业务 Composables 抽取">
      <goal>抽取核心业务 composables：useConnections、useSessions、useChat</goal>
      <tasks>
        <task id="T2.1" name="抽取 useConnections composable" status="DONE" priority="P0">
          将连接管理逻辑从 SessionDockview.vue 抽取到 frontend/src/composables/useConnections.ts。
          包含 connectionPool、activeConnectionId、connectionTokens、connected 等状态，以及 handleNewConnection、handleCreateConnection、handleSelectConnection、fetchConnectionsForAnchor、refreshConnections 等 ~15 个函数。
          包含 apiFetchForConnection、resolveExecutionConnectionId 等跨域工具函数。
          <dependencies>T1.1</dependencies>
          <acceptance_criteria>
            <criterion id="T2.1-AC1" checked="true">useConnections.ts 文件存在且导出 useConnections 函数</criterion>
            <criterion id="T2.1-AC2" checked="true">SessionDockview.vue 中连接相关代码替换为 composable 调用</criterion>
            <criterion id="T2.1-AC3" checked="true">连接创建、选择、刷新功能正常</criterion>
            <criterion id="T2.1-AC4" checked="true">bun test 前端全部通过</criterion>
            <criterion id="T2.1-AC5" checked="true">bun run build 通过</criterion>
          </acceptance_criteria>
          <references>
            <ref>frontend/src/pages/SessionDockview.vue:335-786</ref>
            <ref>frontend/src/pages/SessionDockview.vue:1178-1223</ref>
          </references>
          <subtasks>
            <subtask id="T2.1.1" name="编写 useConnections 测试" status="DONE"/>
            <subtask id="T2.1.2" name="实现 useConnections composable" status="DONE"/>
            <subtask id="T2.1.3" name="替换 SessionDockview.vue 中连接代码" status="DONE"/>
          </subtasks>
        </task>

        <task id="T2.2" name="抽取 useSessions composable" status="DONE" priority="P0">
          将会话管理逻辑从 SessionDockview.vue 抽取到 frontend/src/composables/useSessions.ts。
          包含 sessionId、sessions、sessionWorking、sessionError、sessionShared 等状态，以及 handleSessionSelection、handleCreateSession、loadSessionsForConnection、runSessionAction 等 ~15 个函数。
          接收 activeConnectionId、getTokenForConnection、apiFetchForConnection 作为依赖。
          <dependencies>T2.1</dependencies>
          <acceptance_criteria>
            <criterion id="T2.2-AC1" checked="true">useSessions.ts 文件存在且导出 useSessions 函数</criterion>
            <criterion id="T2.2-AC2" checked="true">SessionDockview.vue 中会话相关代码替换为 composable 调用</criterion>
            <criterion id="T2.2-AC3" checked="true">会话选择、创建、fork/share/summarize/revert 功能正常</criterion>
            <criterion id="T2.2-AC4" checked="true">bun test 前端全部通过</criterion>
            <criterion id="T2.2-AC5" checked="true">bun run build 通过</criterion>
          </acceptance_criteria>
          <references>
            <ref>frontend/src/pages/SessionDockview.vue:789-1141</ref>
            <ref>frontend/src/pages/SessionDockview.vue:1352-1428</ref>
          </references>
          <subtasks>
            <subtask id="T2.2.1" name="编写 useSessions 测试" status="DONE"/>
            <subtask id="T2.2.2" name="实现 useSessions composable" status="DONE"/>
            <subtask id="T2.2.3" name="替换 SessionDockview.vue 中会话代码" status="DONE"/>
          </subtasks>
        </task>

        <task id="T2.3" name="抽取 useChat composable" status="DONE" priority="P0">
          将聊天消息逻辑从 SessionDockview.vue 抽取到 frontend/src/composables/useChat.ts。
          包含 messages、messagesHasOlder、messagesLoadingOlder、messagePollTimer 等状态，以及 handleSendPrompt、handleAbort、refreshMessages、loadOlderMessages、startMessagePolling、stopMessagePolling 等函数。
          接收 activeConnectionId、sessionId、getTokenForConnection、apiFetchForConnection、resolveExecutionConnectionId、capabilities 作为依赖。
          在 onUnmounted 中自动清理 pollTimer。
          <dependencies>T2.2</dependencies>
          <acceptance_criteria>
            <criterion id="T2.3-AC1" checked="true">useChat.ts 文件存在且导出 useChat 函数</criterion>
            <criterion id="T2.3-AC2" checked="true">SessionDockview.vue 中聊天相关代码替换为 composable 调用</criterion>
            <criterion id="T2.3-AC3" checked="true">消息发送、中止、轮询、加载更多功能正常</criterion>
            <criterion id="T2.3-AC4" checked="true">bun test 前端全部通过</criterion>
            <criterion id="T2.3-AC5" checked="true">bun run build 通过</criterion>
          </acceptance_criteria>
          <references>
            <ref>frontend/src/pages/SessionDockview.vue:811-837</ref>
            <ref>frontend/src/pages/SessionDockview.vue:1004-1176</ref>
            <ref>frontend/src/pages/SessionDockview.vue:1225-1350</ref>
          </references>
          <subtasks>
            <subtask id="T2.3.1" name="编写 useChat 测试" status="DONE"/>
            <subtask id="T2.3.2" name="实现 useChat composable" status="DONE"/>
            <subtask id="T2.3.3" name="替换 SessionDockview.vue 中聊天代码" status="DONE"/>
          </subtasks>
        </task>
      </tasks>
      <gate_criteria>
        <criterion>所有 P0 任务完成</criterion>
        <criterion>bun test 前端 15/15 通过</criterion>
        <criterion>bun run build 通过</criterion>
        <criterion>SessionDockview.vue script setup 部分大幅缩减</criterion>
      </gate_criteria>
    </phase>

    <phase id="P3" name="Panel Wrapper 工厂与 Chunk 优化">
      <goal>用通用工厂函数替代手写 panel wrapper，通过 dynamic import 优化 chunk size</goal>
      <tasks>
        <task id="T3.1" name="实现通用 panel wrapper 工厂函数" status="DONE" priority="P0">
          创建 frontend/src/composables/panel-wrapper-factory.ts，导出 createPanelWrapper(component, injectMap) 函数。
          用工厂函数替代 SessionDockview.vue 中 8 个手写 panel wrapper 组件（236 行 Options API 代码）。
          工厂函数返回 Vue Options API 组件定义对象，包含 inject + render 函数。
          <dependencies>T2.3</dependencies>
          <acceptance_criteria>
            <criterion id="T3.1-AC1" checked="true">panel-wrapper-factory.ts 文件存在且导出 createPanelWrapper 函数</criterion>
            <criterion id="T3.1-AC2" checked="true">8 个 panel wrapper 全部由工厂函数生成</criterion>
            <criterion id="T3.1-AC3" checked="true">Options API 代码块缩减至 ≤30 行</criterion>
            <criterion id="T3.1-AC4" checked="true">bun test 前端全部通过</criterion>
            <criterion id="T3.1-AC5" checked="true">bun run build 通过</criterion>
          </acceptance_criteria>
          <references>
            <ref>frontend/src/pages/SessionDockview.vue:1749-1983</ref>
          </references>
          <subtasks>
            <subtask id="T3.1.1" name="编写 panel-wrapper-factory 测试" status="DONE"/>
            <subtask id="T3.1.2" name="实现 createPanelWrapper 工厂函数" status="DONE"/>
            <subtask id="T3.1.3" name="替换 SessionDockview.vue 中 8 个手写 wrapper" status="DONE"/>
          </subtasks>
        </task>

        <task id="T3.2" name="Dynamic import 懒加载优化 chunk size" status="DONE" priority="P1">
          确认 SessionDockview 路由已使用 lazy import。
          将 ChatPanel.vue 中 highlight.js 和 marked 改为 dynamic import 按需加载。
          验证 Vite 自动对 dockview-vue 做 code splitting。
          如需要，在 vite.config.ts 添加 manualChunks 配置。
          目标：SessionDockview 相关 chunk ≤500KB 或首屏不含 dockview。
          <dependencies>T3.1</dependencies>
          <acceptance_criteria>
            <criterion id="T3.2-AC1" checked="true">highlight.js 和 marked 使用 dynamic import</criterion>
            <criterion id="T3.2-AC2" checked="true">dockview 不在首屏 bundle 中</criterion>
            <criterion id="T3.2-AC3" checked="true">bun run build 通过且无 500KB 警告（或 chunk 已拆分）</criterion>
            <criterion id="T3.2-AC4" checked="true">bun test 前端全部通过</criterion>
          </acceptance_criteria>
          <references>
            <ref>frontend/src/components/panels/ChatPanel.vue</ref>
            <ref>frontend/src/router.ts</ref>
            <ref>frontend/vite.config.ts</ref>
          </references>
          <subtasks>
            <subtask id="T3.2.1" name="确认路由 lazy import 现状" status="DONE"/>
            <subtask id="T3.2.2" name="ChatPanel 中 highlight.js/marked 改为 dynamic import" status="DONE"/>
            <subtask id="T3.2.3" name="验证 build 产物 chunk 分布" status="DONE"/>
            <subtask id="T3.2.4" name="按需添加 manualChunks 配置" status="DONE"/>
          </subtasks>
        </task>
      </tasks>
      <gate_criteria>
        <criterion>所有任务完成</criterion>
        <criterion>bun test 前端 15/15 通过</criterion>
        <criterion>bun test 后端 83/83 通过</criterion>
        <criterion>bun run build 通过</criterion>
        <criterion>SessionDockview.vue ≤400 行</criterion>
      </gate_criteria>
    </phase>

    <phase id="P4" name="最终验证">
      <goal>全面验证重构结果，确保行为等价</goal>
      <confirm protocol="yield-human-confirm" when="after" status="DONE" />
      <tasks>
        <task id="T4.1" name="全面回归验证" status="DONE" priority="P0">
          运行所有前端单元测试、后端单元测试。
          验证 SessionDockview.vue 行数 ≤400。
          验证 production build chunk 分布。
          确认所有 composable 文件各自 ≤400 行。
          <dependencies>T3.2</dependencies>
          <acceptance_criteria>
            <criterion id="T4.1-AC1" checked="true">bun test 前端 15/15 通过</criterion>
            <criterion id="T4.1-AC2" checked="true">bun test 后端 83/83 通过</criterion>
            <criterion id="T4.1-AC3" checked="true">SessionDockview.vue ≤400 行</criterion>
            <criterion id="T4.1-AC4" checked="true">每个 composable 文件 ≤400 行</criterion>
            <criterion id="T4.1-AC5" checked="true">production chunk 无 500KB 警告或已合理拆分</criterion>
            <criterion id="T4.1-AC6" checked="true">bun run build 通过</criterion>
          </acceptance_criteria>
          <subtasks>
            <subtask id="T4.1.1" name="运行全部测试套件" status="DONE"/>
            <subtask id="T4.1.2" name="验证文件行数指标" status="DONE"/>
            <subtask id="T4.1.3" name="验证 build 产物 chunk 分布" status="DONE"/>
          </subtasks>
        </task>
      </tasks>
      <gate_criteria>
        <criterion>所有验收标准通过</criterion>
        <criterion>用户确认重构结果</criterion>
      </gate_criteria>
    </phase>
  </phases>

  <validations>
    <validation id="V1" name="行为等价验证" status="PASSED">
      验证重构后所有功能与重构前完全一致
      <checks>
        <check name="连接创建">新建连接流程正常工作</check>
        <check name="会话管理">会话选择、创建、fork/share/revert 正常</check>
        <check name="消息收发">prompt 发送、消息轮询、中止正常</check>
        <check name="布局持久化">调整布局后刷新页面能恢复</check>
        <check name="Composer 控件">agent/model/command 选择器正常</check>
      </checks>
    </validation>
    <validation id="V2" name="代码质量验证" status="PASSED">
      验证重构后代码质量指标达标
      <checks>
        <check name="文件行数">SessionDockview.vue ≤400 行</check>
        <check name="Composable 行数">每个 composable ≤400 行</check>
        <check name="Chunk size">无 500KB 警告或已合理拆分</check>
        <check name="TypeScript">无 any 类型逃逸</check>
      </checks>
    </validation>
  </validations>

  <risks>
    <risk id="R1" name="Composable 间循环依赖" level="medium">
      <impact>中</impact>
      <probability>低</probability>
      <mitigation>严格遵循单向 DAG 依赖图：Notifications → Connections → Sessions/Metadata → Chat</mitigation>
    </risk>
    <risk id="R2" name="Dynamic import 首次交互延迟" level="low">
      <impact>低</impact>
      <probability>中</probability>
      <mitigation>dockview 在路由切换时加载（用户感知为正常延迟）；highlight.js 在首条消息渲染时加载（可用 loading placeholder）</mitigation>
    </risk>
  </risks>

  <summary>
    <total_phases>4</total_phases>
    <total_tasks>8</total_tasks>
    <total_subtasks>22</total_subtasks>
    <completed>8</completed>
    <in_progress>0</in_progress>
    <todo>0</todo>
    <blocked>0</blocked>
    <by_priority>
      <p0 count="7"/>
      <p1 count="1"/>
    </by_priority>
  </summary>
</plan>
